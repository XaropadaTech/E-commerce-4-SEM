<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Detalhes do Produto</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      margin: 0;
      padding: 20px;
    }

    .container {
      max-width: 900px;
      margin: auto;
      background: white;
      border-radius: 20px;
      padding: 20px;
    }

    .product-content {
      display: flex;
      gap: 20px;
    }

    .image-carousel {
      flex: 1;
      position: relative;
      border-radius: 15px;
      overflow: hidden;
    }

    .carousel-slide {
      display: none;
    }

    .carousel-slide.active {
      display: block;
    }

    .carousel-slide img {
      width: 100%;
      border-radius: 15px;
      object-fit: contain;
      height: 400px;
      /* Mant√©m tamanho consistente */
    }

    .carousel-nav {
      position: absolute;
      top: 50%;
      transform: translateY(-50%);
      background: rgba(0, 0, 0, 0.5);
      color: white;
      border: none;
      font-size: 18px;
      padding: 10px;
      cursor: pointer;
      border-radius: 50%;
      user-select: none;
    }

    .carousel-prev {
      left: 10px;
    }

    .carousel-next {
      right: 10px;
    }

    .product-info {
      flex: 1;
    }

    .product-title {
      font-size: 2rem;
      margin-bottom: 10px;
    }

    .product-price {
      font-size: 1.8rem;
      color: #667eea;
      margin-bottom: 15px;
    }

    .product-description {
      margin-bottom: 20px;
    }

    .buy-button {
      width: 100%;
      padding: 15px;
      background: #667eea;
      border: none;
      color: white;
      font-size: 1.2rem;
      font-weight: bold;
      border-radius: 30px;
      cursor: pointer;
      transition: background 0.3s;
    }

    .buy-button:hover {
      background: #555abf;
    }
  </style>
</head>

<body>
    <a href="javascript:void(0);" onclick="history.back();" class="back-button" style="cursor: pointer; text-decoration: underline; color: blue;">
    ‚Üê Voltar
</a>

    <div class="container">
        <div class="header">
        </div>

        <div class="product-content">
            <!-- Carrossel de Imagens -->
            <div class="image-carousel">
                <div th:if="${produto.imagens != null and !produto.imagens.isEmpty()}" class="carousel-container">
                    <!-- Imagem principal (Imagem com imagemPadrao == true) -->
                    <div th:each="imagem, iterStat : ${produto.imagens}" th:if="${imagem.imagemPadrao}" class="carousel-slide" th:classappend="${iterStat.first} ? 'active' : ''">
                        <img th:src="${imagem.caminhoImagem}" th:alt="${produto.nome}" onerror="this.src='data:image/svg+xml;base64,...'">
                    </div>

                    <!-- Outras imagens (imagens com imagemPadrao != true) -->
                    <div th:each="imagem, iterStat : ${produto.imagens}" th:if="${not imagem.imagemPadrao}" class="carousel-slide">
                        <img th:src="${imagem.caminhoImagem}" th:alt="${produto.nome}" onerror="this.src='data:image/svg+xml;base64,...'">
                    </div>

                    <button class="carousel-nav carousel-prev" onclick="changeSlide(-1)">‚ùÆ</button>
                    <button class="carousel-nav carousel-next" onclick="changeSlide(1)">‚ùØ</button>

                    <div class="carousel-indicators">
                        <span th:each="imagem, iterStat : ${produto.imagens}" class="indicator" th:classappend="${iterStat.first} ? 'active' : ''" th:onclick="'currentSlide(' + ${iterStat.index + 1} + ')'"></span>
                    </div>
                </div>

                <div th:if="${produto.imagens == null or produto.imagens.isEmpty()}" class="no-image">
                    üì∑ Nenhuma imagem dispon√≠vel
                </div>
            </div>

            <!-- Informa√ß√µes do Produto -->
            <div class="product-info">
                <h1 class="product-title" th:text="${produto.nome}">Nome do Produto</h1>

                <div class="product-price" th:text="'R$ ' + ${#numbers.formatDecimal(produto.preco, 1, 'POINT', 2, 'COMMA')}">
                    R$ 0,00
                </div>

                <div class="product-rating">
                    <div class="stars">
                        <span class="star" th:each="i : ${#numbers.sequence(1, 5)}" th:classappend="${produto.avaliacao != null and i <= produto.avaliacao.intValue()} ? 'filled' : ''">‚òÖ</span>
                    </div>
                    <span class="rating-text" th:if="${produto.avaliacao != null}" th:text="${#numbers.formatDecimal(produto.avaliacao, 1, 'POINT', 1, 'COMMA')} + ' de 5 estrelas'">
                        0.0 de 5 estrelas
                    </span>
                    <span class="rating-text" th:if="${produto.avaliacao == null}">
                        Sem avalia√ß√µes
                    </span>
                </div>

       

                <div class="product-description" th:if="${produto.descricao != null and !produto.descricao.isEmpty()}">
                    <h3>Descri√ß√£o do Produto</h3>
                    <p th:text="${produto.descricao}">Descri√ß√£o n√£o dispon√≠vel</p>
                </div>

                <div class="buy-section">
                    <button type="button"  
                    class="buy-button"  
                    onclick="addToCart(this)"
                    th:attr="data-id=${produto.id}, data-nome=${produto.nome}, data-preco=${produto.preco}">
                        üõí Comprar 
                    </button>
                 
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSlideIndex = 0;
        const slides = document.querySelectorAll('.carousel-slide');
        const indicators = document.querySelectorAll('.indicator');

        function showSlide(index) {
            // Remove active class from all slides and indicators
            slides.forEach(slide => slide.classList.remove('active'));
            indicators.forEach(indicator => indicator.classList.remove('active'));

            // Add active class to current slide and indicator
            if (slides[index]) {
                slides[index].classList.add('active');
            }
            if (indicators[index]) {
                indicators[index].classList.add('active');
            }
        }

        function changeSlide(direction) {
            currentSlideIndex += direction;

            if (currentSlideIndex >= slides.length) {
                currentSlideIndex = 0;
            } else if (currentSlideIndex < 0) {
                currentSlideIndex = slides.length - 1;
            }

            showSlide(currentSlideIndex);
        }

        function currentSlide(index) {
            currentSlideIndex = index - 1;
            showSlide(currentSlideIndex);
        }

        // Auto-slide (opcional)
        setInterval(() => {
            if (slides.length > 1) {
                changeSlide(1);
            }
        }, 5000);

        // Keyboard navigation
        document.addEventListener('keydown', (e) => {
            if (e.key === 'ArrowLeft') {
                changeSlide(-1);
            } else if (e.key === 'ArrowRight') {
                changeSlide(1);
            }
        });

        // Inicia o carrossel exibindo a primeira imagem
        if (slides.length > 0) {
            showSlide(0);
        }

        // ADICIONANDO PRODUTO NO CARRINHO
         function getActiveImage() {
          const img = document.querySelector('.carousel-slide.active img')
            || document.querySelector('.carousel-slide img');
          return img ? img.getAttribute('src') : '';
        }

        function addToCart(btn) {
          const id = parseInt(btn?.dataset?.id || 0);
          const nome = btn?.dataset?.nome || 'Produto';
          const preco = parseFloat(btn?.dataset?.preco || 0);
          const imagem = getActiveImage();

          const KEY = 'carrinho';
          const carrinho = JSON.parse(localStorage.getItem(KEY) || '[]');

          const idx = carrinho.findIndex(p => p.id === id);
          if (idx >= 0) {
            carrinho[idx].quantidade = (Number(carrinho[idx].quantidade ?? carrinho[idx].qtd ?? 0) || 0) + 1;
          } else {
            carrinho.push({ id, nome, preco, imagem, quantidade: 1 });
          }

          localStorage.setItem(KEY, JSON.stringify(carrinho));

          // S√≥ chama o contador se existir nesta p√°gina
          if (typeof renderCartCount === 'function') {
            try { renderCartCount(); } catch (_) {}
          }

          // ‚úÖ Sempre redireciona, mesmo que algo acima d√™ erro
          window.location.href = '/carrinho';
        }
</script>
</body>

</html>
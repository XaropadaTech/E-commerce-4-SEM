<!DOCTYPE html>
<html lang="pt-BR" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pagamento</title>
<style>
  body { font-family: Arial, Helvetica, sans-serif; background:#f5f7fa; padding:20px; }
  .card { max-width:700px; margin:auto; background:#fff; padding:18px; border-radius:12px; box-shadow:0 6px 18px rgba(0,0,0,.06); }
  h2{ color:#333; margin-top:0 }
  .row{ display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
  label{ font-weight:600; }
  input[type="text"], input[type="number"], select { padding:8px 10px; border:1px solid #ccc; border-radius:8px; width:100%; box-sizing:border-box; }
  .radio-group{ display:flex; gap:16px; align-items:center; margin:8px 0 16px; flex-wrap:wrap; }
  .card-form { margin-top:12px; padding:12px; border-radius:10px; background:#fafafa; border:1px solid #eee; display:none; }
  .pix-info { background:#f0fdf4; border:1px solid #86efac; border-radius:10px; padding:10px; margin-top:12px; display:none; }
  .actions{ display:flex; gap:12px; justify-content:flex-end; margin-top:18px; }
  button{ padding:10px 16px; border-radius:8px; border:none; cursor:pointer; }
  button.primary{ background:#2b6cb0; color:#fff; }
  button.ghost{ background:#e2e8f0; color:#111; }
  .error{ color:#b00020; font-size:.9rem; margin-top:8px; }
  .success{ color:#2e7d32; font-size:.95rem; margin-top:8px; }
</style>
</head>
<body>
<div class="card">
<h2>Pagamento</h2>

<form id="formPagamento" method="post" action="/checkout/pagamento">
  <div>
    <label>Forma de pagamento (selecione uma):</label>
    <div class="radio-group">
      <label><input type="radio" name="metodo" value="BOLETO"> Boleto</label>
      <label><input type="radio" name="metodo" value="CARTAO"> Cartão de Crédito/Débito</label>
      <label><input type="radio" name="metodo" value="PIX"> Pix</label>
    </div>
  </div>

  <!-- Cartão -->
  <div id="cardSection" class="card-form" aria-hidden="true">
    <div class="row">
      <div style="flex:2">
        <label>Número do cartão</label>
        <input id="numeroCartao" name="numeroCartao" type="text" inputmode="numeric" maxlength="23" placeholder="0000 0000 0000 0000">
      </div>
      <div style="flex:1; min-width:110px;">
        <label>CVV</label>
        <!-- sem name: não enviamos CVV ao backend -->
        <input id="cvv" type="text" inputmode="numeric" maxlength="4" placeholder="123">
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div style="flex:2">
        <label>Nome completo</label>
        <input id="nomeTitular" name="nomeCompleto" type="text" placeholder="Nome do titular">
      </div>
      <div style="flex:1; min-width:120px;">
        <label>Validade (MM/AA)</label>
        <input id="dataVencimento" name="validade" type="text" maxlength="5" placeholder="MM/AA">
      </div>
      <div style="flex:1; min-width:120px;">
        <label>Parcelas</label>
        <select id="parcelas" name="parcelas">
          <option value="1">1x</option><option value="2">2x</option><option value="3">3x</option>
          <option value="4">4x</option><option value="5">5x</option><option value="6">6x</option>
        </select>
      </div>
    </div>
  </div>

  <!-- PIX -->
  <div id="pixInfo" class="pix-info" aria-hidden="true">
    <p><strong>Pagamento via Pix</strong></p>
    <p>Após confirmar o pedido, exibiremos o QR Code/código Pix para pagamento.</p>
  </div>

  <div id="feedback" role="status"></div>

  <div class="actions">
    <button class="ghost" type="button" onclick="window.location.href='/checkout/start'">Voltar</button>
    <button class="primary" id="btnValidar" type="button" disabled>Validar pedido final</button>
  </div>
</form>

<script>
  const radios = document.querySelectorAll('input[name="metodo"]');
  const cardSection = document.getElementById('cardSection');
  const pixInfo = document.getElementById('pixInfo');
  const btnValidar = document.getElementById('btnValidar');
  const feedback = document.getElementById('feedback');

  function onlyDigits(s){ return (s||'').replace(/\D/g,''); }
  function maskCardNumber(v){ const d = onlyDigits(v).slice(0,19); return d.replace(/(.{4})/g,'$1 ').trim(); }
  function nomeValido(nome){
    if(!nome) return false;
    const parts = nome.trim().split(/\s+/).filter(Boolean);
    if(parts.length < 2) return false;
    return parts.every(p => p.replace(/[^A-Za-zÀ-ÖØ-öø-ÿ]/g,'').length >= 2);
  }
  function validaCartao(){
    const numero = onlyDigits(document.getElementById('numeroCartao').value);
    const cvv = onlyDigits(document.getElementById('cvv').value);
    const nome = document.getElementById('nomeTitular').value;
    const venc = document.getElementById('dataVencimento').value;
    const parcelas = Number(document.getElementById('parcelas').value);
    if(!numero || numero.length < 13) return false;
    if(!cvv || (cvv.length !==3 && cvv.length !==4)) return false;
    if(!nomeValido(nome)) return false;
    if(!/^(0[1-9]|1[0-2])\/\d{2}$/.test(venc)) return false;
    if(!parcelas || parcelas < 1) return false;
    return true;
  }

  function toggleRequired(el, needed){
    if(!el) return;
    if(needed){ el.setAttribute('required','required'); }
    else{ el.removeAttribute('required'); }
  }

  function atualizaUI(){
    const sel = document.querySelector('input[name="metodo"]:checked');
    // esconde tudo
    cardSection.style.display = 'none';
    cardSection.setAttribute('aria-hidden','true');
    pixInfo.style.display = 'none';
    pixInfo.setAttribute('aria-hidden','true');
    btnValidar.disabled = true;

    // remove required dos campos do cartão quando não for cartão
    const camposCartao = [
      document.getElementById('numeroCartao'),
      document.getElementById('nomeTitular'),
      document.getElementById('dataVencimento'),
      document.getElementById('parcelas')
    ];
    camposCartao.forEach(c => toggleRequired(c, false));

    if(!sel) return;

    if(sel.value === 'CARTAO'){
      cardSection.style.display = 'block';
      cardSection.setAttribute('aria-hidden','false');
      // coloca required só quando for cartão
      camposCartao.forEach(c => toggleRequired(c, true));
      btnValidar.disabled = !validaCartao();
    } else if(sel.value === 'PIX'){
      pixInfo.style.display = 'block';
      pixInfo.setAttribute('aria-hidden','false');
      btnValidar.disabled = false;
    } else { // BOLETO
      btnValidar.disabled = false;
    }
  }

  radios.forEach(r => r.addEventListener('change', atualizaUI));
  document.getElementById('numeroCartao').addEventListener('input',(e)=>{ e.target.value = maskCardNumber(e.target.value); atualizaUI(); });
  document.getElementById('cvv').addEventListener('input',(e)=>{ e.target.value = onlyDigits(e.target.value).slice(0,4); atualizaUI(); });
  document.getElementById('dataVencimento').addEventListener('input',(e)=>{
    let v = onlyDigits(e.target.value).slice(0,4);
    if(v.length >= 3) v = v.slice(0,2) + '/' + v.slice(2);
    e.target.value = v; atualizaUI();
  });
  document.getElementById('nomeTitular').addEventListener('input', atualizaUI);
  document.getElementById('parcelas').addEventListener('change', atualizaUI);

  async function syncEIrParaResumo() {
    try {
      const carrinho = JSON.parse(localStorage.getItem('carrinho') || '[]');
const itens = carrinho.map(p => {
  const preco = Number(p.preco ?? p.precoUnit ?? p.price ?? 0);
  const qtd = Number(p.qtd ?? p.quantidade ?? p.qty ?? 1);
  return {
    produtoId: p.id ?? p.produtoId ?? null,
    nome: p.nome ?? p.title ?? 'Produto',
    precoUnit: isNaN(preco) ? 0 : preco,
    quantidade: isNaN(qtd) ? 1 : qtd
  };
});

// frete pode vir como "12,90", "12.9" ou objeto — normaliza:
let freteLS = localStorage.getItem('frete');
let freteNum = 0;
if (freteLS) {
  try {
    const fObj = JSON.parse(freteLS);
    freteNum = Number(fObj?.valor ?? fObj ?? 0);
  } catch {
    freteNum = Number(String(freteLS).replace(',', '.'));
  }
}
if (isNaN(freteNum)) freteNum = 0;

await fetch('/checkout/sync-cart', {
  method: 'POST',
  headers: {'Content-Type': 'application/json'},
  body: JSON.stringify({ itens, frete: freteNum })
});

      document.getElementById('formPagamento').submit();
    } catch (err) {
      feedback.textContent = 'Erro ao sincronizar o carrinho.';
      feedback.className = 'error';
      btnValidar.disabled = false;
    }
  }

  document.getElementById('btnValidar').addEventListener('click', async ()=>{
    const sel = document.querySelector('input[name="metodo"]:checked');
    if(!sel){
      feedback.textContent = 'Selecione uma forma de pagamento.';
      feedback.className = 'error';
      return;
    }
    if(sel.value === 'CARTAO' && !validaCartao()){
      feedback.textContent = 'Preencha corretamente os dados do cartão.';
      feedback.className = 'error';
      return;
    }
    btnValidar.disabled = true;
    feedback.textContent = '';
    feedback.className = '';
    await syncEIrParaResumo();
  });

  atualizaUI(); // estado inicial
</script>
</body>
</html>

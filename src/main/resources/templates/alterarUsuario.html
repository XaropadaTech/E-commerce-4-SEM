<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Alterar Usuário</title>
</head>
<body>
    <h1>Alterar Usuário</h1>
    <form th:action="@{/usuario/salvar-alteracao}" th:object="${usuario}" method="post">
    <input type="hidden" th:field="*{id}" />

    <label for="nome">Nome:</label>
    <input type="text" th:field="*{nome}" id="nome" required /><br/><br/>

    <label for="cpf">CPF:</label>
    <input type="text" th:field="*{cpf}" id="cpf" required /><br/><br/>

    <!-- Campo de grupo (somente se não estiver alterando a si mesmo) -->
<div th:if="${emailLogado != usuario.email}">
    <label for="grupo">Grupo:</label>
    <select id="grupo" th:field="*{grupo}">
        <option th:value="administrador" th:text="'Administrador'"></option>
        <option th:value="estoquista" th:text="'Estoquista'"></option>
    </select><br/><br/>
</div>

    <label for="senha">Senha:</label>
        <input type="password" th:field="*{senha}" id="senha" /><br/><br/>

        <label for="confirmarSenha">Confirmar Senha:</label>
        <input type="password" id="confirmarSenha" name="confirmarSenha" /><br/><br/>

    <button type="submit">Salvar Alterações</button>
</form>

    <a th:href="@{/listaUsuarios}">Voltar para Lista</a>

    <script th:inline="javascript">
/*<![CDATA[*/
    /* Verifica se existe o atributo antes de tentar usá-lo */
    /* Thymeleaf cria uma variável JS nula se não existir no contexto */
    let sucesso = /*[[${sucesso}]]*/ null;
    let erro = /*[[${erro}]]*/ null;

    if (sucesso !== null) {
        alert(sucesso);
    }

    if (erro !== null) {
        alert(erro);
    }
/*]]>*/

        (function() {
    const cpfInput = document.getElementById('cpf');

    // Função que calcula a validade do CPF
    function validaCPF(cpf) {
        const cpfLimpo = cpf.replace(/[^\d]+/g, '');
        if (cpfLimpo.length !== 11 || /^(\d)\1{10}$/.test(cpfLimpo)) return false;
        let soma = 0, resto;
        for (let i = 1; i <= 9; i++) {
          soma += parseInt(cpfLimpo.substring(i - 1, i)) * (11 - i);
        }
        resto = (soma * 10) % 11;
        if ((resto === 10) || (resto === 11)) resto = 0;
        if (resto !== parseInt(cpfLimpo.substring(9, 10))) return false;
        soma = 0;
        for (let i = 1; i <= 10; i++) {
          soma += parseInt(cpfLimpo.substring(i - 1, i)) * (12 - i);
        }
        resto = (soma * 10) % 11;
        if ((resto === 10) || (resto === 11)) resto = 0;
        if (resto !== parseInt(cpfLimpo.substring(10, 11))) return false;
        return true;
    }

    // Valida o CPF quando o usuário SAI do campo do CPF
    cpfInput.addEventListener('blur', function() {
        const cpfValor = cpfInput.value;

        // Se o campo não estiver vazio e o CPF for inválido...
        if (cpfValor && !validaCPF(cpfValor)) {
            alert('CPF inválido! Por favor, corrija.');
            // Limpa o campo para forçar a correção
            cpfInput.value = '';
        }
    });
})();

</script>
</body>
</html>
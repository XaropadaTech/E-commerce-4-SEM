<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Cadastrar Usuário</title>
</head>
<body>
  <h1 style="text-align:center;">Cadastrar Usuário</h1>

  <form th:action="@{/usuario}" th:object="${usuario}" method="post" novalidate>
    <div th:if="${mensagem}" style="color:green;" th:text="${mensagem}"></div>
    <div th:if="${erro}"     style="color:red;"   th:text="${erro}"></div>


    <div>
      <label for="nome">Nome *</label>
      <input id="nome" type="text" th:field="*{nome}" maxlength="100" placeholder="Digite seu nome" required />
      <div class="erro" th:if="${#fields.hasErrors('nome')}" th:errors="*{nome}">Erro</div>
    </div>

    <div>
      <label for="cpf">CPF *</label>
      <input id="cpf" type="text" th:field="*{cpf}" maxlength="11" placeholder="Somente números" required />
      <div class="erro" th:if="${#fields.hasErrors('cpf')}" th:errors="*{cpf}">Erro</div>
    </div>

    <div>
      <label for="email">E-mail *</label>
      <input id="email" type="email" th:field="*{email}" maxlength="100" placeholder="Digite seu e-mail" />
      <small id="emailMsg" style="color:red;display:none;">E-mail já cadastrado.</small>
      <div class="erro" th:if="${#fields.hasErrors('email')}" th:errors="*{email}">Erro</div>
    </div>

    <!-- <div class="inline">
      <label for="status">Ativo *</label>
      <input id="status" type="checkbox" th:field="*{status}" />
      <div class="erro" th:if="${#fields.hasErrors('status')}" th:errors="*{status}">Erro</div>
    </div> -->

    <div>
      <label for="grupo">Grupo *</label>
      <select id="grupo" th:field="*{grupo}" required>
        <option value="" disabled selected>Selecione...</option>
        <option value="administrador">administrador</option>
        <option value="estoquista">estoquista</option>
      </select>
      <div class="erro" th:if="${#fields.hasErrors('grupo')}" th:errors="*{grupo}">Erro</div>
    </div>

    <div>
      <label for="senha">Senha *</label>
      <input id="senha" type="password" th:field="*{senha}" maxlength="255" required />
      <div class="erro" th:if="${#fields.hasErrors('senha')}" th:errors="*{senha}">Erro</div>
    </div>

    <div>
      <label for="confirmarSenha">Confirmar Senha *</label>
      <input id="confirmarSenha" type="password" name="confirmarSenha" required />
    </div>

    <div class="actions">
      <a class="btn" th:href="@{/listaUsuarios}">Cancelar</a>
      <button class="btn-primary" type="submit">Salvar</button>
    </div>
  </form>

  <script th:inline="javascript">
    // Validação simples de confirmação de senha no cliente
    (function() {
      var form = document.querySelector('form');
      form.addEventListener('submit', function(e) {
        var s1 = document.getElementById('senha').value;
        var s2 = document.getElementById('confirmarSenha').value;
        if (s1 !== s2) {
          e.preventDefault();
          alert('As senhas não coincidem.');
        }
      }
      
      
      );
    })();


    // Validação simples de e-mail do usuário
    (function() {
    const email = document.getElementById('email');
    const msg   = document.getElementById('emailMsg');
    const form  = document.querySelector('form');

    async function checkEmail(value) {
      if (!value) { msg.style.display = 'none'; return false; }
      try {
        const r = await fetch(/*[[@{/usuario/email-exists}]]*/'/usuario/email-exists' + '?email=' + encodeURIComponent(value));
        const exists = await r.json();
        msg.style.display = exists ? 'inline' : 'none';
        return exists;
      } catch(e) {
        // silencioso
        return false;
      }
    }

    email.addEventListener('blur',  () => checkEmail(email.value));
    email.addEventListener('input', () => checkEmail(email.value));

    form.addEventListener('submit', async function(e) {
      const exists = await checkEmail(email.value);
      if (exists) {
        e.preventDefault();
        alert('Já existe um usuário com esse e-mail.');
      }
    });
  })();
  </script>
</body>
</html>
